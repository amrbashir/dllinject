#include "stdafx.h"
#include <iostream>

HINSTANCE g_hDllInst;

namespace
{
	// The 32-bit InjectShellcode function from the project in the inject-shellcode subfolder.
	const BYTE x32Shellcode[] =
								"\x55\x8B\xEC\x83\xEC\x54\x64\xA1\x30\x00\x00\x00\x33\xC9\xC7"
	"\x45\xAC\x49\x6E\x6A\x65\xC7\x45\xB0\x63\x74\x49\x6E\x66\xC7"
	"\x45\xB4\x69\x74\xC6\x45\xB6\x00\x8B\x50\x0C\x8B\x42\x14\x83"
	"\xC2\x14\x53\x33\xDB\xC7\x45\xD8\x00\x00\x00\x00\xC7\x45\xE8"
	"\x00\x00\x00\x00\xC7\x45\xE4\x00\x00\x00\x00\x89\x4D\xFC\x89"
	"\x4D\xF4\x89\x5D\xF0\x89\x4D\xF8\x89\x4D\xE0\x89\x55\xCC\x89"
	"\x45\xEC\x56\x57\x3B\xC2\x0F\x84\x26\x04\x00\x00\xEB\x03\x8B"
	"\x45\xEC\x8B\x78\x28\x33\xD2\x0F\xB7\x70\x24\x0F\xB6\x07\xC1"
	"\xCA\x0D\x03\xD0\x80\x3F\x61\x72\x03\x83\xC2\xE0\x81\xC6\xFF"
	"\xFF\x00\x00\x47\x66\x85\xF6\x75\xE4\x81\xFA\x5B\xBC\x4A\x6A"
	"\x0F\x85\x37\x01\x00\x00\x8B\x45\xEC\xBB\x08\x00\x00\x00\x8B"
	"\x70\x10\x8B\x46\x3C\x8B\x54\x30\x78\x8B\x44\x32\x20\x03\xD6"
	"\x03\xC6\x89\x55\xD0\x89\x45\xD4\x8B\x4A\x24\x03\xCE\x89\x4D"
	"\xDC\x8B\x7A\x18\x85\xFF\x0F\x84\x01\x01\x00\x00\x8B\x10\x03"
	"\xD6\x33\xC0\x8A\x0A\xC1\xC8\x0D\x8D\x52\x01\x0F\xBE\xC9\x03"
	"\xC1\x8A\x0A\x84\xC9\x75\xEF\x3D\xA4\x4E\x0E\xEC\x74\x35\x3D"
	"\xAA\xFC\x0D\x7C\x74\x2E\x3D\xA0\xD5\xC9\x4D\x74\x27\x3D\xAC"
	"\x33\x06\x03\x74\x20\x3D\x66\x19\xDA\x75\x74\x19\x3D\xBC\x22"
	"\x0D\x47\x74\x12\x3D\xFB\x97\xFD\x0F\x74\x0B\x3D\x7C\xC4\x22"
	"\x59\x0F\x85\x95\x00\x00\x00\x8B\x4D\xDC\x0F\xB7\x11\x8B\x4D"
	"\xD0\x8B\x49\x1C\x8D\x0C\x91\x03\xCE\x3D\xA4\x4E\x0E\xEC\x75"
	"\x09\x8B\x01\x03\xC6\x89\x45\xD8\xEB\x6E\x3D\xAA\xFC\x0D\x7C"
	"\x75\x09\x8B\x01\x03\xC6\x89\x45\xE8\xEB\x5E\x3D\xA0\xD5\xC9"
	"\x4D\x75\x09\x8B\x01\x03\xC6\x89\x45\xE4\xEB\x4E\x3D\xAC\x33"
	"\x06\x03\x75\x09\x8B\x01\x03\xC6\x89\x45\xFC\xEB\x3E\x3D\x66"
	"\x19\xDA\x75\x75\x09\x8B\x01\x03\xC6\x89\x45\xF4\xEB\x2E\x3D"
	"\xBC\x22\x0D\x47\x75\x09\x8B\x01\x03\xC6\x89\x45\xF0\xEB\x1E"
	"\x3D\xFB\x97\xFD\x0F\x75\x09\x8B\x01\x03\xC6\x89\x45\xF8\xEB"
	"\x0E\x3D\x7C\xC4\x22\x59\x75\x07\x8B\x01\x03\xC6\x89\x45\xE0"
	"\x81\xC3\xFF\xFF\x00\x00\x8B\x45\xD4\x4F\x83\x45\xDC\x02\x83"
	"\xC0\x04\x89\x45\xD4\x66\x85\xDB\x0F\x85\xF7\xFE\xFF\xFF\x8B"
	"\x5D\xF0\x8B\x7D\xD8\x8B\x75\xE8\x8B\x45\xFC\x8B\x4D\xF4\x8B"
	"\x55\xF8\x85\xFF\x74\x20\x85\xF6\x74\x1C\x83\x7D\xE4\x00\x74"
	"\x16\x85\xC0\x74\x12\x85\xC9\x74\x0E\x85\xDB\x74\x0A\x85\xD2"
	"\x74\x06\x83\x7D\xE0\x00\x75\x4E\x8B\x7D\xEC\x8B\x3F\x3B\x7D"
	"\xCC\x89\x7D\xEC\x8B\x7D\xD8\x0F\x85\x4E\xFE\xFF\xFF\x85\xFF"
	"\x0F\x84\x67\x02\x00\x00\x85\xF6\x0F\x84\x5F\x02\x00\x00\x83"
	"\x7D\xE4\x00\x0F\x84\x55\x02\x00\x00\x85\xC0\x0F\x84\x4D\x02"
	"\x00\x00\x85\xC9\x0F\x84\x45\x02\x00\x00\x85\xDB\x0F\x84\x3D"
	"\x02\x00\x00\x85\xD2\x0F\x84\x35\x02\x00\x00\x8B\x45\xE0\x85"
	"\xC0\x0F\x84\x2A\x02\x00\x00\x8B\x75\x08\x8D\x4D\xDC\x51\x6A"
	"\x01\xC7\x45\xD8\x00\x00\x00\x00\x33\xDB\x8B\x36\xC7\x45\xD4"
	"\x00\x00\x00\x00\xFF\xD0\x83\xFE\x02\x7C\x18\x8D\x45\xC0\xC7"
	"\x45\xC0\x5B\x57\x48\x5D\x50\xC7\x45\xC4\x20\x4C\x4C\x0A\x88"
	"\x5D\xC8\xFF\x55\xF0\x8B\x45\x08\x83\xC0\x18\x50\xFF\xD7\x8B"
	"\xF8\x89\x7D\xD0\x85\xFF\x0F\x84\xC4\x00\x00\x00\x83\xFE\x02"
	"\x7C\x1B\x8D\x45\xC0\xC7\x45\xC0\x5B\x57\x48\x5D\x50\xC7\x45"
	"\xC4\x20\x47\x50\x41\x66\xC7\x45\xC8\x0A\x00\xFF\x55\xF0\x8D"
	"\x45\xAC\x50\x57\xFF\x55\xE8\x89\x45\xCC\x85\xC0\x74\x72\x83"
	"\xFE\x02\x7C\x18\x8D\x45\xC0\xC7\x45\xC0\x5B\x57\x48\x5D\x50"
	"\xC7\x45\xC4\x20\x49\x49\x0A\x88\x5D\xC8\xFF\x55\xF0\x8B\x4D"
	"\x08\xFF\x71\x10\x8D\x79\x10\xC7\x45\xD8\x01\x00\x00\x00\xFF"
	"\x71\x08\x8D\x41\x08\xFF\x71\x04\x89\x45\x08\xFF\x55\xCC\x83"
	"\xC4\x0C\x89\x45\xD4\x83\xFE\x02\x7C\x3C\x85\xC0\xC7\x45\xC0"
	"\x5B\x57\x48\x5D\xC7\x45\xC4\x20\x49\x49\x3A\x0F\x95\xC0\xC6"
	"\x45\xC8\x20\x04\x30\x66\xC7\x45\xCA\x0A\x00\x88\x45\xC9\x8D"
	"\x45\xC0\x50\xFF\x55\xF0\xEB\x11\xFF\x55\xF4\x8B\xD8\x8B\x45"
	"\x08\x8D\x78\x10\x83\xC0\x08\x89\x45\x08\xFF\x75\xD0\xFF\x55"
	"\xE4\x83\x7D\xD4\x00\x0F\x85\x04\x01\x00\x00\xEB\x11\xFF\x55"
	"\xF4\x8B\xD8\x8B\x45\x08\x8D\x78\x10\x83\xC0\x08\x89\x45\x08"
	"\x8B\x07\x8B\x7D\xF8\x85\xC0\x74\x03\x50\xFF\xD7\x8B\x45\x08"
	"\xFF\x30\xFF\xD7\x83\x7D\xD8\x00\x0F\x85\xD4\x00\x00\x00\x83"
	"\xFE\x01\x0F\x8C\xCB\x00\x00\x00\x8B\xCB\xC7\x45\xB8\x5B\x57"
	"\x48\x5D\x83\xE1\x0F\xC7\x45\xBC\x20\x45\x52\x52\x83\xF9\x0A"
	"\x66\xC7\x45\xC0\x3A\x20\x66\xC7\x45\xCA\x0A\x00\x1A\xC0\x80"
	"\xC1\x37\x24\xF9\xC1\xEB\x04\x02\xC1\x8B\xCB\x88\x45\xC9\x83"
	"\xE1\x0F\x83\xF9\x0A\x1A\xC0\xC1\xEB\x04\x24\xF9\x04\x37\x02"
	"\xC1\x8B\xCB\x88\x45\xC8\x83\xE1\x0F\x83\xF9\x0A\x1A\xC0\xC1"
	"\xEB\x04\x24\xF9\x04\x37\x02\xC1\x8B\xCB\x88\x45\xC7\x83\xE1"
	"\x0F\x83\xF9\x0A\x1A\xC0\xC1\xEB\x04\x24\xF9\x04\x37\x02\xC1"
	"\x8B\xCB\x88\x45\xC6\x83\xE1\x0F\x83\xF9\x0A\x1A\xC0\xC1\xEB"
	"\x04\x24\xF9\x04\x37\x02\xC1\x8B\xCB\x88\x45\xC5\x83\xE1\x0F"
	"\x83\xF9\x0A\x1A\xC0\xC1\xEB\x04\x24\xF9\x04\x37\x02\xC1\x8B"
	"\xCB\x88\x45\xC4\x83\xE1\x0F\x83\xF9\x0A\x1A\xC0\x80\xC1\x37"
	"\x24\xF9\xC1\xEB\x04\x02\xC1\x83\xFB\x0A\x88\x45\xC3\x1A\xC0"
	"\x24\xF9\x04\x37\x02\xC3\x88\x45\xC2\x8D\x45\xB8\x50\xFF\x55"
	"\xF0\x6A\x00\xFF\x75\xDC\xFF\x55\xE0\x8B\x45\xFC\x5F\x5E\x5B"
	"\x8B\xE5\x5D\xC2\x04\x00";

	constexpr SIZE_T x32ShellcodeSize = sizeof(x32Shellcode) - 1;

#define PRE_X64SHELLCODE_VIRTUAL_FREE                             \
	"\x48\x83\xEC\x28"			   /* sub rsp,28               */ \
	"\xE8\x20\x00\x00\x00"		   /* call $+20                */ \
	"\x48\x83\xC4\x28"			   /* add rsp,28               */ \
	"\x48\x85\xC0"				   /* test rax,rax             */ \
	"\x75\x01"					   /* jne $+1                  */ \
	"\xC3"						   /* ret                      */ \
	"\x48\x8D\x0D\x00\x00\x00\x00" /* lea rcx,qword ptr ds:[$] */ \
	"\x66\x81\xE1\x00\xF0"		   /* and cx,F000              */ \
	"\x33\xD2"					   /* xor edx,edx              */ \
	"\x41\xB8\x00\x80\x00\x00"	   /* mov r8d,8000             */ \
	"\xFF\xE0"					   /* jmp rax                  */

	// The 64-bit InjectShellcode function from the project in the inject-shellcode subfolder.
	const BYTE x64Shellcode[] =
		PRE_X64SHELLCODE_VIRTUAL_FREE
	"\x48\x89\x4C\x24\x08\x55\x53\x56\x57\x41\x54\x41\x55\x41\x56"
	"\x41\x57\x48\x8B\xEC\x48\x83\xEC\x78\x33\xFF\xC7\x45\xC0\x49"
	"\x6E\x6A\x65\xC7\x45\xC4\x63\x74\x49\x6E\x44\x8B\xD7\x66\xC7"
	"\x45\xC8\x69\x74\x44\x8B\xDF\xC6\x45\xCA\x00\x8B\xF7\x65\x48"
	"\x8B\x04\x25\x60\x00\x00\x00\x44\x8B\xEF\x48\x89\x7D\xE8\x44"
	"\x8B\xE7\x48\x89\x7D\x58\x44\x8B\xFF\x48\x89\x7D\x60\x44\x8B"
	"\xF7\x48\x8B\x40\x18\x48\x83\xC0\x20\x48\x89\x7D\xD8\x48\x89"
	"\x7D\xD0\x48\x89\x7D\xE0\x48\x89\x7D\xF0\x48\x8B\x18\x48\x89"
	"\x45\xA8\x48\x89\x5D\x50\x48\x3B\xD8\x0F\x84\x5A\x04\x00\x00"
	"\x66\x0F\x1F\x84\x00\x00\x00\x00\x00\x4C\x8B\x43\x50\x48\x8B"
	"\xC7\x44\x0F\xB7\x4B\x48\xBB\xFF\xFF\x00\x00\x0F\x1F\x40\x00"
	"\x66\x66\x66\x0F\x1F\x84\x00\x00\x00\x00\x00\x41\x0F\xB6\x10"
	"\x4D\x8D\x40\x01\xC1\xC8\x0D\x8B\xC8\x48\x03\xCA\x80\xFA\x61"
	"\x48\x8D\x41\xE0\x48\x0F\x42\xC1\x66\x44\x03\xCB\x75\xDF\x48"
	"\x8B\x5D\x50\x3D\x5B\xBC\x4A\x6A\x0F\x85\x6C\x01\x00\x00\x4C"
	"\x8B\x4B\x20\xBF\x08\x00\x00\x00\x49\x63\x41\x3C\x42\x8B\x84"
	"\x08\x88\x00\x00\x00\x49\x03\xC1\x48\x89\x45\xD0\x44\x8B\x50"
	"\x20\x44\x8B\x58\x24\x4D\x03\xD1\x8B\x58\x18\x4D\x03\xD9\x0F"
	"\x1F\x00\x85\xDB\x0F\x84\x1A\x01\x00\x00\x41\x8B\x12\x49\x03"
	"\xD1\x33\xC0\x0F\xB6\x0A\x0F\x1F\x40\x00\x66\x0F\x1F\x84\x00"
	"\x00\x00\x00\x00\xC1\xC8\x0D\x48\x8D\x52\x01\x0F\xBE\xC9\x03"
	"\xC1\x0F\xB6\x0A\x84\xC9\x75\xED\x3D\xA4\x4E\x0E\xEC\x74\x35"
	"\x3D\xAA\xFC\x0D\x7C\x74\x2E\x3D\xA0\xD5\xC9\x4D\x74\x27\x3D"
	"\xAC\x33\x06\x03\x74\x20\x3D\x66\x19\xDA\x75\x74\x19\x3D\xBC"
	"\x22\x0D\x47\x74\x12\x3D\xFB\x97\xFD\x0F\x74\x0B\x3D\x7C\xC4"
	"\x22\x59\x0F\x85\xA0\x00\x00\x00\x48\x8B\x4D\xD0\x45\x0F\xB7"
	"\x03\x8B\x51\x1C\x49\x03\xD1\x3D\xA4\x4E\x0E\xEC\x75\x0D\x42"
	"\x8B\x04\x82\x49\x03\xC1\x48\x89\x45\x58\xEB\x76\x3D\xAA\xFC"
	"\x0D\x7C\x75\x0D\x42\x8B\x04\x82\x49\x03\xC1\x48\x89\x45\x60"
	"\xEB\x62\x3D\xA0\xD5\xC9\x4D\x75\x0D\x42\x8B\x04\x82\x49\x03"
	"\xC1\x48\x89\x45\xD8\xEB\x4E\x3D\xAC\x33\x06\x03\x75\x09\x42"
	"\x8B\x34\x82\x49\x03\xF1\xEB\x3E\x3D\x66\x19\xDA\x75\x75\x09"
	"\x46\x8B\x2C\x82\x4D\x03\xE9\xEB\x2E\x3D\xBC\x22\x0D\x47\x75"
	"\x09\x46\x8B\x24\x82\x4D\x03\xE1\xEB\x1E\x3D\xFB\x97\xFD\x0F"
	"\x75\x09\x46\x8B\x3C\x82\x4D\x03\xF9\xEB\x0E\x3D\x7C\xC4\x22"
	"\x59\x75\x07\x46\x8B\x34\x82\x4D\x03\xF1\xB8\xFF\xFF\x00\x00"
	"\x66\x03\xF8\x49\x83\xC2\x04\x49\x83\xC3\x02\xFF\xCB\x66\x85"
	"\xFF\x0F\x85\xDE\xFE\xFF\xFF\x4C\x8B\x55\x60\x33\xFF\x4C\x8B"
	"\x5D\xD8\x48\x8B\x5D\x50\x4C\x89\x75\xF0\x4C\x89\x7D\xE0\x48"
	"\x89\x75\xD0\x48\x8B\x55\x58\x48\x85\xD2\x74\x23\x4D\x85\xD2"
	"\x74\x1E\x4D\x85\xDB\x74\x19\x48\x85\xF6\x74\x14\x4D\x85\xED"
	"\x74\x0F\x4D\x85\xE4\x74\x0A\x4D\x85\xFF\x74\x05\x4D\x85\xF6"
	"\x75\x59\x48\x8B\x1B\x48\x89\x5D\x50\x48\x3B\x5D\xA8\x0F\x85"
	"\x07\xFE\xFF\xFF\x48\x85\xD2\x0F\x84\x4F\x02\x00\x00\x4D\x85"
	"\xD2\x0F\x84\x46\x02\x00\x00\x4D\x85\xDB\x0F\x84\x3D\x02\x00"
	"\x00\x48\x85\xF6\x0F\x84\x34\x02\x00\x00\x4D\x85\xED\x0F\x84"
	"\x2B\x02\x00\x00\x4D\x85\xE4\x0F\x84\x22\x02\x00\x00\x4D\x85"
	"\xFF\x0F\x84\x19\x02\x00\x00\x4D\x85\xF6\x0F\x84\x10\x02\x00"
	"\x00\x48\x8B\x5D\x48\x48\x8D\x55\x50\xB9\x01\x00\x00\x00\x8B"
	"\xF7\x8B\x1B\x41\xFF\xD6\x83\xFB\x02\x7C\x19\x48\x8D\x4D\xA8"
	"\xC7\x45\xA8\x5B\x57\x48\x5D\xC7\x45\xAC\x20\x4C\x4C\x0A\xC6"
	"\x45\xB0\x00\x41\xFF\xD4\x48\x8B\x4D\x48\x48\x8B\x45\x58\x48"
	"\x83\xC1\x18\xFF\xD0\x4C\x8B\xF0\x48\x85\xC0\x0F\x84\xB4\x00"
	"\x00\x00\x83\xFB\x02\x7C\x1B\x48\x8D\x4D\xA8\xC7\x45\xA8\x5B"
	"\x57\x48\x5D\xC7\x45\xAC\x20\x47\x50\x41\x66\xC7\x45\xB0\x0A"
	"\x00\x41\xFF\xD4\x48\x8D\x55\xC0\x49\x8B\xCE\xFF\x55\x60\x4C"
	"\x8B\xF8\x48\x85\xC0\x74\x69\x83\xFB\x02\x7C\x19\x48\x8D\x4D"
	"\xA8\xC7\x45\xA8\x5B\x57\x48\x5D\xC7\x45\xAC\x20\x49\x49\x0A"
	"\xC6\x45\xB0\x00\x41\xFF\xD4\x48\x8B\x45\x48\xC7\x45\xE8\x01"
	"\x00\x00\x00\x4C\x8B\x40\x10\x48\x8B\x50\x08\x8B\x48\x04\x41"
	"\xFF\xD7\x8B\xF0\x83\xFB\x02\x7C\x30\x85\xC0\xC7\x45\xA8\x5B"
	"\x57\x48\x5D\x48\x8D\x4D\xA8\xC7\x45\xAC\x20\x49\x49\x3A\x0F"
	"\x95\xC0\xC6\x45\xB0\x20\x04\x30\x66\xC7\x45\xB2\x0A\x00\x88"
	"\x45\xB1\x41\xFF\xD4\xEB\x05\x41\xFF\xD5\x8B\xF8\x49\x8B\xCE"
	"\xFF\x55\xD8\x85\xF6\x0F\x85\x08\x01\x00\x00\x4C\x8B\x7D\xE0"
	"\xEB\x05\x41\xFF\xD5\x8B\xF8\x48\x8B\x75\x48\x48\x8B\x4E\x10"
	"\x48\x85\xC9\x74\x03\x41\xFF\xD7\x48\x8B\x4E\x08\x41\xFF\xD7"
	"\x83\x7D\xE8\x00\x0F\x85\xDC\x00\x00\x00\x83\xFB\x01\x0F\x8C"
	"\xD3\x00\x00\x00\x8B\xCF\xC7\x45\xA8\x5B\x57\x48\x5D\x83\xE1"
	"\x0F\xC7\x45\xAC\x20\x45\x52\x52\x83\xF9\x0A\x66\xC7\x45\xB0"
	"\x3A\x20\xBA\x30\x00\x00\x00\x66\xC7\x45\xBA\x0A\x00\x41\xB8"
	"\x37\x00\x00\x00\x8B\xC2\x41\x0F\x43\xC0\xC1\xEF\x04\x02\xC1"
	"\x8B\xCF\x83\xE1\x0F\x88\x45\xB9\x83\xF9\x0A\x8B\xC2\x41\x0F"
	"\x43\xC0\xC1\xEF\x04\x02\xC1\x8B\xCF\x83\xE1\x0F\x88\x45\xB8"
	"\x83\xF9\x0A\x8B\xC2\x41\x0F\x43\xC0\xC1\xEF\x04\x02\xC1\x8B"
	"\xCF\x83\xE1\x0F\x88\x45\xB7\x83\xF9\x0A\x8B\xC2\x41\x0F\x43"
	"\xC0\xC1\xEF\x04\x02\xC1\x8B\xCF\x83\xE1\x0F\x88\x45\xB6\x83"
	"\xF9\x0A\x8B\xC2\x41\x0F\x43\xC0\xC1\xEF\x04\x02\xC1\x8B\xCF"
	"\x83\xE1\x0F\x88\x45\xB5\x83\xF9\x0A\x8B\xC2\x41\x0F\x43\xC0"
	"\xC1\xEF\x04\x02\xC1\x8B\xCF\x83\xE1\x0F\x88\x45\xB4\x83\xF9"
	"\x0A\x8B\xC2\x41\x0F\x43\xC0\xC1\xEF\x04\x02\xC1\x48\x8D\x4D"
	"\xA8\x83\xFF\x0A\x88\x45\xB3\x41\x0F\x43\xD0\x40\x02\xD7\x88"
	"\x55\xB2\x41\xFF\xD4\x8B\x4D\x50\x33\xD2\xFF\x55\xF0\x48\x8B"
	"\x45\xD0\xEB\x03\x48\x8B\xC6\x48\x83\xC4\x78\x41\x5F\x41\x5E"
	"\x41\x5D\x41\x5C\x5F\x5E\x5B\x5D\xC3";

	constexpr SIZE_T x64ShellcodeSize = sizeof(x64Shellcode) - 1;

	//
	// https://docs.microsoft.com/en-us/windows/win32/sysinfo/verifying-the-system-version
	//
	BOOL CheckWindowsVersion(DWORD dwMajorVersion, DWORD dwMinorVersion,
							 WORD wServicePackMajor, WORD wServicePackMinor, int op)
	{
		// Initialize the OSVERSIONINFOEX structure
		OSVERSIONINFOEX osvi;

		ZeroMemory(&osvi, sizeof(OSVERSIONINFOEX));
		osvi.dwOSVersionInfoSize = sizeof(OSVERSIONINFOEX);
		osvi.dwMajorVersion = dwMajorVersion;
		osvi.dwMinorVersion = dwMinorVersion;
		osvi.wServicePackMajor = wServicePackMajor;
		osvi.wServicePackMinor = wServicePackMinor;

		// Initialize the type mask
		DWORD dwTypeMask = VER_MAJORVERSION | VER_MINORVERSION |
						   VER_SERVICEPACKMAJOR | VER_SERVICEPACKMINOR;

		// Initialize the condition mask
		DWORDLONG dwlConditionMask = 0;

		VER_SET_CONDITION(dwlConditionMask, VER_MAJORVERSION, op);
		VER_SET_CONDITION(dwlConditionMask, VER_MINORVERSION, op);
		VER_SET_CONDITION(dwlConditionMask, VER_SERVICEPACKMAJOR, op);
		VER_SET_CONDITION(dwlConditionMask, VER_SERVICEPACKMINOR, op);

		// Perform the test
		return VerifyVersionInfo(&osvi, dwTypeMask, dwlConditionMask);
	}

	//
	// Based on:
	// http://securityxploded.com/ntcreatethreadex.php
	//
	HANDLE MyCreateRemoteThread(HANDLE hProcess,
								LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, USHORT targetProcessArch)
	{
#ifndef _WIN64
		if (targetProcessArch == IMAGE_FILE_MACHINE_AMD64)
		{
			// WOW64 to x64 native, use heaven's gate.
			return (HANDLE)CreateRemoteThread64(
				HANDLE_TO_DWORD64(hProcess), PTR_TO_DWORD64(lpStartAddress), PTR_TO_DWORD64(lpParameter));
		}
#endif // _WIN64

		using NtCreateThreadEx_t = NTSTATUS(WINAPI *)(
			OUT PHANDLE hThread,
			IN ACCESS_MASK DesiredAccess,
			IN LPVOID ObjectAttributes,
			IN HANDLE ProcessHandle,
			IN LPTHREAD_START_ROUTINE lpStartAddress,
			IN LPVOID lpParameter,
			IN BOOL CreateSuspended,
			IN ULONG_PTR StackZeroBits,
			IN ULONG_PTR SizeOfStackCommit,
			IN ULONG_PTR SizeOfStackReserve,
			OUT LPVOID lpBytesBuffer);

		static NtCreateThreadEx_t pNtCreateThreadEx = []()
		{
			// Only needed for Windows Vista and 7.
			if (CheckWindowsVersion(6, 0, 0, 0, VER_GREATER_EQUAL) &&
				!CheckWindowsVersion(6, 2, 0, 0, VER_GREATER_EQUAL))
			{
				HMODULE hNtdll = GetModuleHandle(L"ntdll.dll");
				if (hNtdll)
				{
					return (NtCreateThreadEx_t)GetProcAddress(hNtdll, "NtCreateThreadEx");
				}
			}

			return (NtCreateThreadEx_t) nullptr;
		}();

		LPSECURITY_ATTRIBUTES lpThreadAttributes = nullptr;
		DWORD dwCreationFlags = 0;

		if (pNtCreateThreadEx)
		{
			HANDLE hThread;
			ULONG_PTR bOutBuffer1[2];
			ULONG_PTR bOutBuffer2[1];
			struct
			{
				ULONG_PTR Size;
				ULONG_PTR Unknown1;
				ULONG_PTR nBuf1Size;
				void *pBuf1;
				ULONG_PTR Unknown2;
				ULONG_PTR Unknown3;
				ULONG_PTR nBuf2Size;
				void *pBuf2;
				ULONG_PTR Unknown4;
			} param = {sizeof(param), 0x10003, sizeof(ULONG_PTR) * 2, bOutBuffer1, 0, 0x10004, sizeof(ULONG_PTR), bOutBuffer2, 0};

			NTSTATUS result = pNtCreateThreadEx(&hThread, 0x1FFFFF, lpThreadAttributes,
												hProcess, lpStartAddress, lpParameter, (dwCreationFlags & CREATE_SUSPENDED) ? TRUE : FALSE, 0, 0, 0, &param);
			if (result < 0)
			{
				SetLastError(LsaNtStatusToWinError(result));
				return nullptr;
			}

			return hThread;
		}

		return CreateRemoteThread(hProcess, lpThreadAttributes, 0, lpStartAddress, lpParameter, dwCreationFlags, nullptr);
	}

	USHORT GetProcessArch(HANDLE hProcess)
	{
		// For now, only IMAGE_FILE_MACHINE_I386 and IMAGE_FILE_MACHINE_AMD64.
		// TODO: Use IsWow64Process2 if available.

#ifndef _WIN64
		SYSTEM_INFO siSystemInfo;
		GetNativeSystemInfo(&siSystemInfo);
		if (siSystemInfo.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_INTEL)
		{
			// 32-bit machine, only one option.
			return IMAGE_FILE_MACHINE_I386;
		}
#endif // _WIN64

		BOOL bIsWow64Process;
		if (IsWow64Process(hProcess, &bIsWow64Process) && bIsWow64Process)
		{
			return IMAGE_FILE_MACHINE_I386;
		}

		return IMAGE_FILE_MACHINE_AMD64;
	}

	// Struct expected by the shellcode
	struct InjectData
	{
		DWORD debugLevel; // offset 0x00
		DWORD reserved1;  // offset 0x04
		DWORD reserved2;  // offset 0x08
		DWORD reserved3;  // offset 0x0C
		DWORD reserved4;  // offset 0x10
		DWORD reserved5;  // offset 0x14
						  // DLL path follows at offset 0x18
	};
}

// Exported
extern "C"
{
	DWORD __declspec(dllexport) InjectDll(HANDLE hProcess, wchar_t *dll32Path, wchar_t *dll64Path)
	{

#ifndef _WIN64
		Wow64ExtInitialize();
#endif // _WIN64

		const BYTE *shellcode;
		size_t shellcodeSize;
		std::wstring dllPath;

		USHORT targetProcessArch = GetProcessArch(hProcess);

		switch (targetProcessArch)
		{
		case IMAGE_FILE_MACHINE_I386:
			shellcode = x32Shellcode;
			shellcodeSize = x32ShellcodeSize;
			dllPath = std::wstring(dll32Path);
			break;

		case IMAGE_FILE_MACHINE_AMD64:
			shellcode = x64Shellcode;
			shellcodeSize = x64ShellcodeSize;
			dllPath = std::wstring(dll64Path);
			break;

		default:
			return ERROR_INVALID_PARAMETER;
		}

		size_t dllPathBytes = (dllPath.length() + 1) * sizeof(WCHAR);
		size_t dataStructSize = sizeof(InjectData) + dllPathBytes;

		size_t shellcodeSizeAligned = (shellcodeSize + (sizeof(LONG_PTR) - 1)) & ~(sizeof(LONG_PTR) - 1);

		// Allocate enough memory in the remote process's address space
		// to hold the shellcode and the data struct.
		void *pRemoteCode = VirtualAllocEx(
			hProcess, nullptr, shellcodeSizeAligned + dataStructSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
		if (pRemoteCode == nullptr)
		{
			return GetLastError();
		}

		auto remoteCodeCleanup = wil::scope_exit([hProcess, pRemoteCode]
												 { VirtualFreeEx(hProcess, pRemoteCode, 0, MEM_RELEASE); });

		// Write our shellcode into the remote process.
		if (!WriteProcessMemory(hProcess, pRemoteCode, shellcode, shellcodeSize, nullptr))
		{
			return GetLastError();
		}

		// Prepare the inject data struct
		std::vector<BYTE> injectDataBuffer(dataStructSize, 0);
		InjectData *pInjectData = reinterpret_cast<InjectData *>(injectDataBuffer.data());
		pInjectData->debugLevel = 2; // Enable debug output in shellcode

		// Copy DLL path after the struct header
		memcpy(injectDataBuffer.data() + sizeof(InjectData), dllPath.c_str(), dllPathBytes);

		// Write the complete struct to remote process
		void *pRemoteData = reinterpret_cast<BYTE *>(pRemoteCode) + shellcodeSizeAligned;
		if (!WriteProcessMemory(hProcess, pRemoteData, injectDataBuffer.data(), dataStructSize, nullptr))
		{
			return GetLastError();
		}

		// Mark shellcode as executable.
		DWORD oldProtect;
		if (!VirtualProtectEx(hProcess, pRemoteCode, shellcodeSize, PAGE_EXECUTE_READ, &oldProtect))
		{
			return GetLastError();
		}

		wil::unique_process_handle hRemoteThread(MyCreateRemoteThread(hProcess,
																	  reinterpret_cast<LPTHREAD_START_ROUTINE>(pRemoteCode), pRemoteData, targetProcessArch));
		if (!hRemoteThread)
		{
			return GetLastError();
		}

		DWORD waitResult = WaitForSingleObject(hRemoteThread.get(), INFINITE);
		if (waitResult == WAIT_OBJECT_0)
		{

			DWORD exitCode;
			if (GetExitCodeThread(hRemoteThread.get(), &exitCode))
			{
				if (exitCode == 0)
				{
				}
			}
			else
			{
			}
		}
		else
		{
		}

		remoteCodeCleanup.release();

		return ERROR_SUCCESS;
	}
}
